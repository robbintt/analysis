---
ver: rpa2
title: 'TempRe: Template generation for single and direct multi-step retrosynthesis'
arxiv_id: '2507.21762'
source_url: https://arxiv.org/abs/2507.21762
tags:
- tempre
- template
- direct
- reaction
- templates
- transformers
- self-attention
- retrieval-augmented-generation
- instruction-tuning
- parameter-efficient-finetuning
- mixture-of-experts
- chain-of-thought
core_contribution: The paper introduces TempRe, a generative framework for retrosynthesis
  planning that reformulates template-based approaches as sequence generation. This
  method addresses the limitations of traditional template classification (poor scalability)
  and template-free generative methods (risk of invalid outputs) by combining their
  advantages.
---

# TempRe: Template generation for single and direct multi-step retrosynthesis

## Quick Facts
- **arXiv ID:** 2507.21762
- **Source URL:** https://arxiv.org/abs/2507.21762
- **Reference count:** 40
- **Key outcome:** TempRe is a generative framework that reformulates template-based retrosynthesis as sequence generation, achieving superior performance on both single-step and multi-step tasks compared to template classification and SMILES-based methods.

## Executive Summary
TempRe addresses the limitations of traditional template-based retrosynthesis by generating reaction templates (SMARTS) as sequences rather than classifying from a fixed library or generating reactants directly. This approach decouples output length from input size, enabling better performance on large molecules while maintaining chemical validity through deterministic template application. The framework shows strong performance on single-step retrosynthesis and extends to direct multi-step route generation, providing a lightweight alternative to conventional search-based methods.

## Method Summary
TempRe uses a sequence-to-sequence Transformer architecture where the encoder processes target molecule SMILES and the decoder generates reaction template SMARTS tokens. The predicted template is then applied to the target molecule using RDChiral to produce reactants. The model is trained on USPTO data with various tokenization strategies (BPE or frequency-based) and evaluated on single-step accuracy and multi-step route generation through MCTS integration or direct generation.

## Key Results
- TempRe outperforms both template classification (AiZynthFinder) and SMILES-based generation methods on single-step retrosynthesis tasks
- The model demonstrates stable performance across molecular weight ranges where SMILES-based approaches deteriorate
- On PaRoutes multi-step benchmark, TempRe achieves strong top-k route accuracy with direct generation showing promise despite training data bias toward shorter routes

## Why This Works (Mechanism)

### Mechanism 1
- **Claim:** Generating reaction templates mitigates length generalization failure observed in direct SMILES generation for large molecules.
- **Mechanism:** Template generation decouples output length from input size because templates describe only the local reaction center (fixed short length) regardless of total molecule size.
- **Core assumption:** Reaction center complexity does not scale linearly with molecular weight.
- **Evidence anchors:**
  - [Section 5.1]: P2R accuracy deteriorates with increasing molecular weight while P2T remains stable
  - [Figure 2c]: Shows stable Top-5 accuracy for P2T across MW bins where P2R fails
- **Break condition:** If reaction center grows linearly with molecule size (e.g., macrocyclizations), efficiency may diminish.

### Mechanism 2
- **Claim:** Reformulating retrosynthesis as template generation acts as a bottleneck for chemical validity.
- **Mechanism:** Instead of generating variable reactant structures directly, the model generates a template that is deterministically applied to the target molecule. Invalid applications are filtered out before propagating.
- **Core assumption:** RDChiral serves as a reliable hard constraint for chemical plausibility.
- **Evidence anchors:**
  - [Section 3.1]: q(R|o, t) maps template t and molecule o to reactants R
  - [Section 5.3/Case Study]: P2R proposes chemically implausible "shortcut" reactions
- **Break condition:** If model generates valid but chemically meaningless SMARTS that falsely match the target.

### Mechanism 3
- **Claim:** Tokenization of templates allows scalable handling of vast reaction spaces better than multi-class classification.
- **Mechanism:** TempRe treats templates as sequences of tokens, allowing composition of rare or novel templates from shared substructures rather than memorizing IDs.
- **Core assumption:** Reaction templates share syntactic regularities captured by BPE or frequency-based tokenization.
- **Evidence anchors:**
  - [Section 5.1]: TempRe substantially outperforms AZF for rare templates
  - [Table 1]: TempRe parameter counts (20M) vs AZF (122M)
- **Break condition:** If dataset contains primarily unique, non-repeating template structures.

## Foundational Learning

- **Concept: SMARTS vs. SMILES**
  - **Why needed here:** Core innovation is generating SMARTS (templates/patterns) rather than SMILES (molecules). SMARTS describe substructural patterns used for graph matching.
  - **Quick check question:** Can a valid SMARTS template be applied to a molecule it does not match? (Answer: No, application returns null/empty).

- **Concept: Retrosynthesis vs. Forward Synthesis**
  - **Why needed here:** Task is "retrosynthesis" (deconstructing target). Model predicts retro-template that breaks target into precursors.
  - **Quick check question:** If model predicts a template, which direction does reaction arrow point in planning logic? (Answer: Backwards from product to reactants).

- **Concept: MCTS (Monte Carlo Tree Search)**
  - **Why needed here:** Paper evaluates "Direct" generation vs. "Search-based" (MCTS). Understanding that MCTS iteratively builds tree using single-step model as policy is required to interpret multi-step results.
  - **Quick check question:** In TempRe + MCTS setup, does Transformer perform the search? (Answer: No, suggests candidates for search algorithm to expand).

## Architecture Onboarding

- **Component map:** Input SMILES → Tokenizer → Encoder/Decoder → Beam Search (Top-K Templates) → Strict Filtering (optional) → RDChiral Application → Valid Precursors

- **Critical path:** Input SMILES → Tokenize → Encoder/Decoder → Beam Search (Top-K Templates) → Strict Filtering (Check against training set if P2T-Strict) → RDChiral Application → Valid Precursors

- **Design tradeoffs:**
  - **Strict vs. Unrestricted:** Strict variants discard templates not seen in training, trading novelty for reliability
  - **Accuracy vs. Solve Rate:** Unrestricted models have higher solve rates but lower top-k accuracy

- **Failure signatures:**
  - **Syntactic Hallucination:** Generating SMARTS strings that are valid text but chemically nonsense
  - **Mismatched Application:** Generating valid template that doesn't match input molecule
  - **Length Bias (Direct TempRe):** Model defaults to predicting shorter routes than ground truth

- **First 3 experiments:**
  1. **Sanity Check (Single-Step):** Train P2T and P2R on small subset, verify P2T generates valid SMARTS and P2T-Strict filters correctly
  2. **OOD Robustness Test:** Evaluate on molecules with MW > 500, plot accuracy vs. MW to replicate length generalization finding
  3. **Novelty vs. Validity:** Run inference on "Hard" test set, manually inspect templates not in training library for plausibility

## Open Questions the Paper Calls Out
None

## Limitations
- Length generalization advantage may not hold for reaction classes where reaction center scales with molecular size (e.g., macrocyclizations)
- Multi-step evaluation relies on PaRoutes benchmark which may not reflect performance on diverse industrial synthesis problems
- Direct multi-step generation suffers from training data bias toward shorter routes, requiring additional inference-time conditioning

## Confidence
**High Confidence:** Template generation improves length generalization in single-step retrosynthesis is well-supported by experimental data showing stable performance across molecular weight bins
**Medium Confidence:** Template generation acts as chemical validity bottleneck is supported by case studies but needs systematic quantitative validation
**Medium Confidence:** Advantage over template classification demonstrated through parameter efficiency and rare template performance, but long-term scalability remains to be validated

## Next Checks
1. **Macrocycle Reaction Test:** Evaluate TempRe on macrocyclization reactions where reaction center encompasses entire ring system to measure length generalization advantage
2. **Template Novelty Analysis:** Systematically study templates generated by P2T-Unrestricted not in training set, manually classify as plausible/invalid/novel discoveries
3. **Real-world Benchmark Transfer:** Test TempRe on independent industrial synthesis dataset to evaluate PaRoutes benchmark performance translation to practical retrosynthesis planning
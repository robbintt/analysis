---
ver: rpa2
title: 'SQuARE: Structured Query & Adaptive Retrieval Engine For Tabular Formats'
arxiv_id: '2512.04292'
source_url: https://arxiv.org/abs/2512.04292
tags:
- retrieval
- square
- header
- flat
- merged
- transformers
- self-attention
- retrieval-augmented-generation
- instruction-tuning
- parameter-efficient-finetuning
- mixture-of-experts
- chain-of-thought
core_contribution: SQuARE is a hybrid retrieval framework that dynamically routes
  spreadsheet queries to either structure-preserving chunk retrieval or SQL over an
  automatically constructed relational view, based on a sheet's structural complexity
  (header depth and merged-cell density). A lightweight agent supervises the retrieval,
  refinement, or combination of results across both paths when confidence is low.
---

# SQuARE: Structured Query & Adaptive Retrieval Engine For Tabular Formats

## Quick Facts
- arXiv ID: 2512.04292
- Source URL: https://arxiv.org/abs/2512.04292
- Authors: Chinmay Gondhalekar; Urjitkumar Patel; Fang-Chun Yeh
- Reference count: 29
- SQuARE outperforms single-strategy baselines and ChatGPT-4o on retrieval precision and end-to-end answer accuracy for spreadsheet QA while maintaining predictable latency.

## Executive Summary
SQuARE is a hybrid retrieval framework that dynamically routes spreadsheet queries to either structure-preserving chunk retrieval or SQL over an automatically constructed relational view, based on a sheet's structural complexity (header depth and merged-cell density). A lightweight agent supervises the retrieval, refinement, or combination of results across both paths when confidence is low. This approach preserves header hierarchies, time labels, and units, ensuring answers are faithful to the original cells and straightforward to verify. Evaluated on multi-header corporate balance sheets, a heavily merged World Bank workbook, and diverse public datasets, SQuARE consistently outperforms single-strategy baselines and ChatGPT-4o on both retrieval precision and end-to-end answer accuracy while maintaining predictable latency. The system's decoupling of retrieval from model choice ensures compatibility with emerging tabular foundation models, offering a practical bridge toward more robust table understanding.

## Method Summary
SQuARE computes a structural complexity score based on header depth and merged-cell density, then routes queries either through structure-preserving chunk retrieval or SQL execution over a relational view. For chunk retrieval, sheets are segmented at header boundaries with metadata preserving header paths, time labels, and units. SQL mode uses inferred schemas with strict constraints. A lightweight agent monitors confidence and may switch paths or merge partial evidence when uncertainty is high. The system is evaluated on multi-header corporate balance sheets, merged World Bank workbooks, and diverse public datasets, showing consistent improvements over single-strategy baselines and ChatGPT-4o.

## Key Results
- SQuARE consistently outperforms single-strategy baselines and ChatGPT-4o on both retrieval precision and end-to-end answer accuracy
- Ablation of fallback mechanism costs 4-6 points in accuracy across settings
- Maintains predictable latency while handling complex spreadsheet structures

## Why This Works (Mechanism)

### Mechanism 1: Structural Complexity Scoring and Adaptive Routing
- Claim: A continuous score based on header depth and merge density enables sheet-appropriate retrieval path selection.
- Mechanism: Compute X = αH + βM (H = header depth, M = merged-cell count), then classify as Multi-Header if H ≥ 2 or merge density d ≥ ρ (0.10–0.15). Multi-Header sheets route exclusively to chunk retrieval; Flat sheets enable both SQL and chunk paths.
- Core assumption: Header depth and merge density are sufficient proxies for "structure that SQL cannot handle reliably."
- Evidence anchors:
  - [abstract]: "computes a continuous score based on header depth and merge density, then routes queries either through structure-preserving chunk retrieval or SQL"
  - [section III-B]: "X = αH + βM... Class(W) = Multi-Header, if H ≥ 2 or d ≥ ρ, Flat, otherwise"
  - [corpus]: TableRAG (2506.10380) similarly observes that flattening tables disrupts intrinsic structure, but does not implement dynamic routing.
- Break condition: Sheets with sparse merges but semantic nesting (e.g., implicit hierarchies without merged cells) may misclassify as Flat, routing to SQL when chunk retrieval would be safer.

### Mechanism 2: Structure-Preserving Segmentation with Explicit Metadata
- Claim: Segmenting at header boundaries and attaching metadata preserves contextual meaning that fixed-window chunking destroys.
- Mechanism: Each block Bi receives metadata (Hi, Yi, Ui) = (header path, time labels, units). Embeddings are generated from two-sentence descriptions Di, not raw cells. Retrieval returns top-k blocks via cosine similarity.
- Core assumption: Two-sentence descriptions capture enough semantic content for accurate similarity matching without losing critical structure.
- Evidence anchors:
  - [abstract]: "preserves header hierarchies, time labels, and units, ensuring answers are faithful to the original cells"
  - [section III-C]: "meta(Bi) = (Hi, Yi, Ui)... Each block receives a brief two-sentence description Di"
  - [corpus]: Chain-of-Query (2508.15809) uses multi-agent SQL collaboration but does not address header-boundary segmentation.
- Break condition: If descriptions omit critical qualifiers (e.g., "adjusted vs. unadjusted"), retrieval may return semantically similar but numerically wrong blocks.

### Mechanism 3: Confidence-Gated Fallback and Context Merging
- Claim: A lightweight agent monitoring confidence scores reduces unrecoverable errors by switching paths or merging evidence.
- Mechanism: After primary retrieval, a quality gate checks confidence (cosine similarity for chunks; non-emptiness and schema coverage for SQL). If below threshold θ, try alternate path (Flat sheets only), then merge contexts if both partial, summarize if token budget exceeded, else abstain.
- Core assumption: Confidence heuristics correlate with answer correctness; merging partial evidence improves over single-path failure.
- Evidence anchors:
  - [abstract]: "lightweight agent supervises retrieval, refinement, or combination of results across both paths when confidence is low"
  - [section V-E]: "Removing fallback costs 4-6 points across settings"
  - [corpus]: Weak corpus evidence—neighbor papers do not implement confidence-gated merging for hybrid tabular retrieval.
- Break condition: If both paths produce plausible but contradictory evidence (e.g., different units), merging may amplify confusion rather than resolve it.

## Foundational Learning

- Concept: Vector embeddings and cosine similarity retrieval
  - Why needed here: SQuARE embeds block descriptions and retrieves via similarity; understanding embedding quality and distance metrics is essential for debugging retrieval failures.
  - Quick check question: Given two block descriptions with similar content but different units (e.g., "millions" vs. "thousands"), will cosine similarity distinguish them?

- Concept: SQL generation with schema constraints
  - Why needed here: The SQL path generates constrained queries over inferred schemas; understanding SQL guardrails (whitelisted columns, row caps) prevents unsafe or malformed queries.
  - Quick check question: If a schema inference step mislabels a column type (string as numeric), what SQL operations will fail?

- Concept: Multi-row headers and merged cells in spreadsheets
  - Why needed here: The complexity score hinges on detecting these structures; misidentification directly affects routing accuracy.
  - Quick check question: A sheet has three header rows but no merged cells—how does SQuARE classify it, and which retrieval path is activated?

## Architecture Onboarding

- Component map:
  - Complexity Scorer (H, M → class label) -> Index Builder (semantic index Ic for all sheets; relational view Is for Flat only) -> Router Agent (query + sheet label → mode selection: chunk/sql) -> Chunk Retriever (FAISS-based, top-k blocks) / SQL Generator/Executor (constrained SQL over inferred schema) -> Quality Gate (confidence threshold θ) -> [pass: Answer LLM] / [fail: Fallback → alternate/merge → Quality Gate → Answer or Abstain]

- Critical path: Query → Router Agent → (Chunk OR SQL) → Quality Gate → [pass: Answer LLM] / [fail: Fallback → alternate/merge → Quality Gate → Answer or Abstain]

- Design tradeoffs:
  - Chunk-only: Better for nested headers, units, and layout-dependent queries; weaker on aggregations.
  - SQL-only: Stronger for filters/aggregates on flat tables; fails on multi-row headers and unit rows.
  - Hybrid + Fallback: Higher accuracy (4-6 points per ablation) but added latency and LLM invocation budget.

- Failure signatures:
  - Misclassified sheet (Flat when Multi-Header): SQL generation returns wrong columns or ignores units.
  - Low-confidence merge with contradictory units: Answer may conflate "millions" and "thousands."
  - Empty SQL result on aggregation query: Likely schema mismatch or overly strict WHERE clause.

- First 3 experiments:
  1. Routing accuracy audit: Run complexity scorer on a held-out set of sheets with known ground-truth labels; measure classification precision/recall.
  2. Retrieval-only evaluation: Disable answer LLM; measure R@k for chunk and SQL paths separately to isolate retrieval quality.
  3. Fallback ablation: Run full SQuARE vs. No-Fallback variant on Flat tables; quantify accuracy delta and latency impact per query tier (Easy/Medium/Hard).

## Open Questions the Paper Calls Out

- **Question**: Can a learned routing agent with uncertainty estimates reduce fallback rates compared to the current prompt-based routing method?
  - Basis in paper: [explicit] Section VI states the agentic router is prompt-based and suggests "A lightweight learned router with uncertainty estimates could reduce fallbacks and sharpen confidence checks."
  - Why unresolved: The current implementation relies on heuristics and prompt engineering for routing decisions rather than a trained model capable of optimizing the decision boundary.
  - What evidence would resolve it: A comparative study measuring fallback frequency and answer accuracy between the current prompt-based agent and a trained classifier on the same dataset.

- **Question**: Does incorporating schema alignment and safe join discovery extend SQuARE's capabilities to accurate multi-sheet or cross-workbook querying?
  - Basis in paper: [explicit] Section VI notes that SQL generation is fragile under schema drift and identifies a plan to "support multi sheet and cross workbook queries with explicit, verifiable joins."
  - Why unresolved: The current system restricts SQL generation to single sheets and lacks mechanisms for handling schema heterogeneity or joining tables across files.
  - What evidence would resolve it: Successful execution and accuracy metrics of complex queries requiring joins across multiple workbooks compared to baseline single-sheet performance.

- **Question**: Do Tabular Foundation Models (TFMs) improve performance when used as drop-in encoders for structure and units within the SQuARE framework?
  - Basis in paper: [explicit] Section VI suggests TFMs could serve as "drop in encoders for structure and units" while preserving the RAG+SQL orchestration.
  - Why unresolved: The paper utilizes general-purpose LLMs (Gemma/Llama) and has not yet empirically validated the integration of specialized tabular pre-trained models.
  - What evidence would resolve it: Benchmarking results showing retrieval precision and end-to-end accuracy when swapping the current embedding model for TFM-based encoders.

## Limitations

- **Major Uncertainty**: Absence of released QA pairs and raw spreadsheet files prevents exact replication of reported accuracy numbers.
- **Implementation Detail**: Confidence heuristics (threshold θ, exact quality gate logic) are only sketched in the paper.
- **Missing Specification**: Embedding model specification is missing, requiring assumption-driven choices that may impact retrieval quality.

## Confidence

- **High**: The hybrid routing mechanism based on structural complexity is well-specified and logically sound. The observed ablation results (4-6 point accuracy gain from fallback) are plausible given the design.
- **Medium**: The effectiveness of two-sentence descriptions for capturing header/unit semantics depends heavily on prompt quality and is not fully validated in isolation.
- **Low**: End-to-end accuracy claims cannot be independently verified without the source data and exact prompt templates.

## Next Checks

1. **Routing Accuracy Audit**: Implement the complexity scorer and classify a held-out set of spreadsheets with known ground-truth labels. Measure classification precision/recall to ensure Multi-Header vs. Flat decisions align with structural realities.
2. **Retrieval-Only Evaluation**: Disable the answer generation step and evaluate R@k for chunk and SQL retrieval paths separately on benchmark sheets. This isolates retrieval quality from LLM variability.
3. **Fallback Ablation Study**: Run SQuARE with and without the fallback mechanism on Flat tables, measuring accuracy delta and per-query latency to quantify the practical cost-benefit tradeoff.
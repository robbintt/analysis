---
ver: rpa2
title: Terminally constrained flow-based generative models from an optimal control
  perspective
arxiv_id: '2601.09474'
source_url: https://arxiv.org/abs/2601.09474
tags:
- terminal
- control
- flow
- optimal
- cost
- transformers
- self-attention
- retrieval-augmented-generation
- instruction-tuning
- parameter-efficient-finetuning
- mixture-of-experts
- chain-of-thought
core_contribution: This paper addresses the problem of sampling from terminally constrained
  distributions using pre-trained flow-based generative models. The authors formulate
  this as an optimal control problem, deriving a Hamilton-Jacobi-Bellman equation
  and optimal feedback control.
---

# Terminally constrained flow-based generative models from an optimal control perspective

## Quick Facts
- arXiv ID: 2601.09474
- Source URL: https://arxiv.org/abs/2601.09474
- Reference count: 40
- This paper addresses the problem of sampling from terminally constrained distributions using pre-trained flow-based generative models.

## Executive Summary
This paper tackles the challenge of sampling from terminally constrained distributions using pre-trained flow-based generative models. The authors formulate this as an optimal control problem, deriving a Hamilton-Jacobi-Bellman equation and optimal feedback control. They show that as the control penalty increases, the controlled process recovers the reference distribution, while as the penalty vanishes, the terminal law converges to a generalized Wasserstein projection onto the constraint manifold. The proposed method, TOCFlow, offers a geometry-aware sampling-time guidance method that solves the control problem in a terminal co-moving frame, yielding a closed-form scalar damping factor along the Riemannian gradient.

## Method Summary
The paper introduces Terminal Optimal Control with Flow-based models (TOCFlow), a novel approach to sampling from terminally constrained distributions using pre-trained flow-based generative models. The method formulates the problem as an optimal control problem, deriving a Hamilton-Jacobi-Bellman equation and optimal feedback control. TOCFlow solves the control problem in a terminal co-moving frame, yielding a closed-form scalar damping factor along the Riemannian gradient. This approach is computationally efficient, matching the geometric consistency of Gauss-Newton updates at the cost of standard gradient guidance. The method is evaluated on three high-dimensional scientific tasks: Darcy flow (PDE constraints), constrained trajectory planning (inequality constraints), and turbulence snapshot generation (spectral constraints).

## Key Results
- TOCFlow improves constraint satisfaction over Euclidean guidance and projection baselines while preserving the reference model's generative quality.
- The method matches the geometric consistency of Gauss-Newton updates at the computational cost of standard gradient guidance.
- Across all evaluated tasks (Darcy flow, trajectory planning, turbulence), TOCFlow demonstrates superior performance in satisfying constraints without compromising sample quality.

## Why This Works (Mechanism)
TOCFlow works by framing terminally constrained sampling as an optimal control problem. The method derives a Hamilton-Jacobi-Bellman equation and optimal feedback control, which allows for efficient computation of a scalar damping factor along the Riemannian gradient. This approach ensures geometric consistency while maintaining computational efficiency comparable to standard gradient guidance methods.

## Foundational Learning
- **Optimal Control Theory**: Needed for formulating the sampling problem as an optimal control problem. Quick check: Verify understanding of Hamilton-Jacobi-Bellman equation and its role in deriving optimal feedback control.
- **Flow-based Generative Models**: Essential for understanding the pre-trained velocity field and how TOCFlow modifies it. Quick check: Confirm knowledge of how flow matching models generate samples through diffusion processes.
- **Riemannian Geometry**: Required for understanding the geometric consistency of the method and the computation of the scalar damping factor. Quick check: Ensure comprehension of how the flow-induced metric affects the control update.

## Architecture Onboarding
- **Component Map**: Base Flow Model (e.g., DiT, FNO, U-Net) -> TOCSolver (Algorithm 4) -> Controlled Velocity Field
- **Critical Path**: Pre-trained velocity field -> lookahead estimation -> gradient computation -> scalar damping calculation -> controlled velocity application
- **Design Tradeoffs**: Balance between constraint satisfaction and preserving the reference model's generative quality; computational efficiency vs. more complex solvers
- **Failure Signatures**: Lookahead divergence (exploding norms), stiff ODE dynamics (NaNs or artifacts), poor constraint satisfaction
- **First Experiments**:
    1. Implement base Flow Matching model on a simple dataset (e.g., 2D Gaussian) and verify sample quality
    2. Implement TOCSolver with a simple constraint (e.g., mean constraint) and test on the base model
    3. Compare constraint satisfaction and sample quality between TOCFlow and vanilla guidance on a toy problem

## Open Questions the Paper Calls Out
- Can specialized solvers be developed for TOCFlow when terminal costs possess favorable structural properties like convexity or decomposability?
- How robust is the linear constraint decay assumption when applied to constraints with high non-linearity or complex manifold geometry?
- Is there a principled, adaptive method for determining the weight schedule parameters without resorting to extensive grid search?

## Limitations
- The optimal hyperparameters (lookahead steps, weight schedule parameters) appear to be tuned per task, potentially limiting generalization.
- The method's performance depends on accurate integration via Heun's method, which may be sensitive to ODE solver choice.
- The comparison with "Approximated Gauss-Newton" relies on a specific interpolation pull-back strategy, which may be challenging to reproduce exactly.

## Confidence
- **Generalization of TOCFlow**: Medium - Tested on three domains but hyperparameters appear task-specific
- **Baseline Comparison**: Medium - Relies on specific implementation of "Approximated Gauss-Newton"
- **Numerical Stability**: Medium - Depends on ODE solver choice and may be sensitive to stiff dynamics

## Next Checks
1. **Ablation on lookahead steps $k$**: Systematically vary $k$ (e.g., 1, 2, 4, 8) and measure constraint satisfaction vs. runtime to confirm the claimed efficiency.
2. **Solver robustness test**: Replace Heun's method with a higher-order solver (e.g., RK4) or an adaptive step-size method to assess whether numerical errors impact the constraint satisfaction or sample quality.
3. **Scaling to larger domains**: Apply TOCFlow to a larger Darcy flow problem (e.g., 128x128) or a higher-dimensional trajectory planning task to verify that the geometric consistency and computational efficiency scale as claimed.
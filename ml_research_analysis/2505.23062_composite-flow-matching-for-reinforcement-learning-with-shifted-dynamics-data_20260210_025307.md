---
ver: rpa2
title: Composite Flow Matching for Reinforcement Learning with Shifted-Dynamics Data
arxiv_id: '2505.23062'
source_url: https://arxiv.org/abs/2505.23062
tags:
- offline
- flow
- dynamics
- data
- online
- transformers
- self-attention
- retrieval-augmented-generation
- instruction-tuning
- parameter-efficient-finetuning
- mixture-of-experts
- chain-of-thought
core_contribution: COMPFLOW addresses the challenge of reinforcement learning with
  shifted dynamics by introducing a composite flow matching approach. The method models
  online dynamics using a conditional flow built upon a pretrained offline flow, rather
  than learning from scratch.
---

# Composite Flow Matching for Reinforcement Learning with Shifted-Dynamics Data

## Quick Facts
- **arXiv ID:** 2505.23062
- **Source URL:** https://arxiv.org/abs/2505.23062
- **Reference count:** 40
- **One-line primary result:** COMPFLOW achieves 14.2% improvement over strongest baseline (2193 vs 1920 score) and outperforms or matches state-of-the-art methods on 24 of 27 tasks.

## Executive Summary
COMPFLOW addresses reinforcement learning with shifted dynamics by introducing a composite flow matching approach that models online dynamics using a conditional flow built upon a pretrained offline flow. The method enables principled estimation of the dynamics gap via Wasserstein distance between offline and online transitions, avoiding the limitations of KL divergence when distributions have disjoint support. Empirically, COMPFLOW achieves a 14.2% improvement over the strongest baseline, reaching a score of 2193 versus 1920, and demonstrates effectiveness in a real-world wildlife conservation task with 20.8% improvement over training from scratch.

## Method Summary
The method pretrains an offline flow on static data to model offline transition dynamics, then builds a composite online flow initialized from the offline flow's output distribution to model the shifted online dynamics. The dynamics gap is estimated via Monte Carlo sampling of the squared Wasserstein distance between the two flows, which is then used both for filtering offline data (including samples with low gap estimates) and as an exploration bonus in policy optimization. The policy is trained using SAC with modified losses that incorporate behavior cloning regularization and the gap-based exploration bonus.

## Key Results
- COMPFLOW achieves a 14.2% improvement over the strongest baseline (2193 vs 1920 score)
- Outperforms or matches state-of-the-art methods on 24 of 27 tasks
- Demonstrates 20.8% improvement in real-world wildlife conservation task over training from scratch

## Why This Works (Mechanism)

### Mechanism 1: Principled Dynamics Gap Estimation via Wasserstein Distance
The composite flow architecture enables stable estimation of the dynamics gap where KL divergence fails by building the online flow on top of the pretrained offline flow output. This design allows the transport cost of the learned flow to directly approximate the squared 2-Wasserstein distance between offline and online conditional transition distributions, which remains well-defined even when the two distributions have disjoint support. The core assumption is that the offline and online environments share meaningful structural similarity such that the offline distribution is a closer starting point to the online distribution than a standard Gaussian.

### Mechanism 2: Transfer Learning for Dynamics Generalization
Reusing the pretrained offline flow structure reduces the generalization error of the online dynamics model under limited data by acting as a residual learning process. The online flow only needs to learn the "shift" from the offline model, resulting in straighter trajectories and lower discretization error. This mechanism assumes the offline dataset captures transition dynamics somewhat relevant to the online environment, making the dynamics shift a deviation rather than a total reset.

### Mechanism 3: Optimistic Exploration in High-Gap Regions
Using the estimated dynamics gap as an intrinsic reward bonus reduces the performance gap to the optimal policy by incentivizing exploration in regions where offline data provides poor guidance. The policy optimizes with an exploration bonus: $a = \arg \max [Q(s,a) + \beta \hat{\Delta}(s,a)]$. This mechanism assumes the estimated gap is sufficiently accurate to identify high-uncertainty regions where the agent should collect corrective data rather than overfitting to low-gap regions where offline data already suffices.

## Foundational Learning

- **Concept: Flow Matching / Rectified Flow**
  - **Why needed here:** This is the generative backbone of the method. You must understand how ODE-based flows transport a source distribution to a target distribution via velocity fields to grasp how the composite architecture works.
  - **Quick check question:** Can you explain why learning a straight-line path between distributions reduces discretization error compared to curved paths?

- **Concept: Optimal Transport (OT) & Wasserstein Distance**
  - **Why needed here:** The paper hinges on the connection between flow matching and OT. Understanding $W_2$ distance is crucial to see why it solves the "mismatched support" problem of KL divergence.
  - **Quick check question:** Why does Wasserstein distance remain defined when two distributions have disjoint support, while KL divergence fails?

- **Concept: Offline-to-Online RL**
  - **Why needed here:** The context is utilizing a static dataset for a changing environment. You need to understand the trade-offs between behavior cloning (stability) and policy improvement (optimality) to interpret the loss functions.
  - **Quick check question:** Why does standard off-policy RL fail when the dynamics of the offline data differ significantly from the online environment?

## Architecture Onboarding

- **Component map:** Offline Flow -> Composite Online Flow -> Gap Estimator -> Active Buffer -> SAC Agent
- **Critical path:** The correctness of the Gap Estimator (Composite Flow) is the linchpin. If the Wasserstein distance is estimated poorly, both the data filtering and exploration bonus will fail.
- **Design tradeoffs:**
  - **Alignment Cost ($\eta$):** Controls how strictly the OT coupling matches state-action pairs. High $\eta$ enforces conditional coupling but may be numerically unstable; low $\eta$ risks comparing transitions from different states.
  - **Selection Ratio ($\xi$):** High $\xi$ trusts more offline data (risking bias); Low $\xi$ is safer but sample-inefficient.
- **Failure signatures:**
  - **Mode Collapse in Gap Estimation:** If $\hat{\Delta}(s,a)$ collapses to zero or high values indiscriminately, the buffer will either include all offline data (poisoning) or none (sample inefficiency).
  - **Divergent Online Flow:** If the composite flow ODE diverges, the gap estimates become NaN.
- **First 3 experiments:**
  1. **Sanity Check - MSE Prediction:** Train Direct vs. Composite flow on a small subset of online data. Verify Composite achieves lower MSE (replicate Figure 3).
  2. **Ablation - OT Alignment:** Visualize the coupling pairs. Check if high-cost pairs in the OT matrix correspond to transitions with significantly different $(s,a)$.
  3. **Hyperparameter Sensitivity:** Sweep $\xi$ (filtering ratio) to find the tipping point where including more offline data hurts performance due to dynamics shift.

## Open Questions the Paper Calls Out

### Open Question 1
- **Question:** Can the dynamics gap be estimated in a shared latent embedding space to enable transfer between domains with mismatched state or action spaces?
- **Basis in paper:** Appendix A (Limitations) states the method is currently limited to settings with shared state/action spaces and suggests exploring latent embeddings to relax this assumption.
- **Why unresolved:** The current composite flow architecture relies on computing Wasserstein distances directly in the raw state space $\mathcal{S}$, which requires the spaces to be identical.
- **What evidence would resolve it:** A modified framework that maps observations to a latent space before flow matching, successfully transferring policies between environments with different observation modalities.

### Open Question 2
- **Question:** Can quantifying uncertainty in the dynamics gap estimation improve the robustness of data filtering and exploration strategies?
- **Basis in paper:** Appendix A identifies the lack of uncertainty quantification as a limitation and suggests it could improve future iterations of the method.
- **Why unresolved:** The Monte Carlo estimator provides a point estimate of the gap but does not model the confidence of this estimate, potentially leading to noisy filtering.
- **What evidence would resolve it:** An ablation study showing that weighting the exploration bonus by the inverse of the estimation variance leads to higher asymptotic returns or stability in low-data regimes.

### Open Question 3
- **Question:** Can the exploration strength ($\beta$) and data selection ratio ($\xi$) be adapted automatically rather than relying on manual tuning?
- **Basis in paper:** Section 5.1.3 notes that the optimal values for $\beta$ and $\xi$ are task-dependent and vary significantly across different environments.
- **Why unresolved:** The current implementation requires a grid search over these hyperparameters to find the best trade-off between exploration and exploitation.
- **What evidence would resolve it:** A meta-learning algorithm or heuristic that dynamically adjusts $\beta$ and $\xi$ during training, achieving performance comparable to the optimal fixed parameters without manual intervention.

## Limitations
- Performance improvements are primarily demonstrated on benchmark MuJoCo tasks with controlled shifts, requiring validation on real-world complex dynamics
- Critical reliance on accurate dynamics gap estimation creates potential failure mode if composite flow cannot reliably estimate Wasserstein distances
- OT alignment weight $\eta$ is not specified, creating uncertainty about optimal coupling strength
- Theoretical guarantees depend on assumptions about gap estimator accuracy that are difficult to verify in practice

## Confidence

- **High Confidence:** The core mechanism of using composite flow to model online dynamics and estimate dynamics gap via Wasserstein distance is theoretically sound and empirically validated on benchmark tasks.
- **Medium Confidence:** The specific hyperparameter choices (filtering ratio $\xi$, exploration weight $\beta$) and their impact on performance in different shift scenarios are well-documented, though optimal settings may vary.
- **Medium Confidence:** The real-world applicability is demonstrated but limited to a single conservation task, requiring further validation across diverse domains.
- **Low Confidence:** The theoretical bounds on performance gap reduction (Theorem 3.5) depend on assumptions about gap estimator accuracy that are difficult to verify in practice.

## Next Checks

1. **OT Coupling Quality Verification:** Visualize the optimal transport coupling matrix between offline and online transitions. Check whether high-cost pairs correspond to transitions with significantly different $(s,a)$ values, validating the gap estimation mechanism.

2. **Shift Magnitude Sensitivity:** Systematically vary the magnitude of dynamics shifts (e.g., friction coefficients, morphology changes) to identify the breaking point where the offline flow becomes a detrimental initialization for the online flow.

3. **Gap Estimator Ablation:** Compare the composite flow gap estimator against alternative gap estimation methods (e.g., KL divergence, direct MSE) to quantify the specific contribution of the Wasserstein-based approach to final performance.
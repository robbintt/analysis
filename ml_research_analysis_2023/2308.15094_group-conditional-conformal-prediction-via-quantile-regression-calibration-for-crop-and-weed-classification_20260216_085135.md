---
ver: rpa2
title: Group-Conditional Conformal Prediction via Quantile Regression Calibration
  for Crop and Weed Classification
arxiv_id: '2308.15094'
source_url: https://arxiv.org/abs/2308.15094
tags:
- prediction
- conformal
- coverage
- quantile
- group
- transformers
- self-attention
- retrieval-augmented-generation
- instruction-tuning
- parameter-efficient-finetuning
- mixture-of-experts
- chain-of-thought
core_contribution: This paper applies conformal prediction to provide statistical
  guarantees on the performance of deep learning models for weed and crop classification
  under real-world agricultural conditions. The authors demonstrate that marginal
  conformal prediction methods, while achieving valid coverage on average, fail to
  maintain coverage on specific groups of individuals defined by environmental and
  pedo-climological metadata.
---

# Group-Conditional Conformal Prediction via Quantile Regression Calibration for Crop and Weed Classification

## Quick Facts
- arXiv ID: 2308.15094
- Source URL: https://arxiv.org/abs/2308.15094
- Reference count: 34
- Primary result: Group-conditional conformal prediction via quantile regression maintains coverage for all groups while producing smaller prediction sets than iterative methods.

## Executive Summary
This paper addresses the challenge of ensuring reliable weed and crop classification under real-world agricultural conditions using conformal prediction. The authors demonstrate that while marginal conformal prediction achieves valid coverage on average, it fails to maintain coverage for specific groups defined by environmental and pedo-climological metadata. To address this limitation, they propose a group-conditional conformal prediction approach using quantile regression to jointly estimate decision quantiles for all groups. The method successfully maintains the required 90% coverage level for all groups while producing smaller prediction sets compared to iterative group-conditional approaches, making it particularly valuable for precision agriculture applications where performance guarantees across different environmental conditions are essential.

## Method Summary
The proposed method extends conformal prediction to handle group-conditional coverage requirements by using quantile regression for calibration. Instead of the traditional iterative approach that estimates quantiles separately for each group, the authors reformulate the calibration procedure as a joint quantile regression problem over group membership indicators. The approach uses auxiliary metadata (such as location and sky conditions) as explanatory variables to model the conditional quantile of conformity scores for each group. This allows for efficient estimation of all group-specific quantiles simultaneously while leveraging shared information across groups. The method is evaluated on a proprietary dataset of 218,000 RGB images of crops and weeds, demonstrating improved coverage maintenance and smaller prediction set sizes compared to baseline approaches.

## Key Results
- Marginal conformal prediction achieves 90% average coverage but fails to maintain coverage for specific environmental groups
- Group-conditional conformal prediction via quantile regression maintains 90% coverage for all groups
- The quantile regression approach produces smaller average prediction set sizes compared to iterative group-conditional calibration
- Coverage remains stable across 100 bootstrap iterations, with naturally higher variance for less-represented groups

## Why This Works (Mechanism)

### Mechanism 1
- Claim: Marginal conformal prediction provides valid coverage on average but fails to guarantee coverage for specific groups defined by auxiliary metadata.
- Mechanism: The quantile estimation step is based on the full calibration set without conditioning on group membership, so the resulting decision quantile does not adapt to group-specific score distributions.
- Core assumption: Observations are exchangeable, but this does not imply conditional coverage for arbitrary groups.
- Evidence anchors:
  - [abstract]: "marginal conformal prediction methods, while achieving valid coverage on average, fail to maintain coverage on specific groups of individuals defined by environmental and pedo-climological metadata."
  - [section]: "The coverage of the base point predictor (which corresponds to its Top-1 overall accuracy) is 68%, with a unique set size of 1... The APS procedure maintains the coverage exactly at the required 1 − α = 0 .9 level... However, the picture changes when we look at the conditional coverage per group."
- Break condition: If the calibration set is too small or unrepresentative for a particular group, the marginal quantile will be biased for that group, breaking conditional coverage.

### Mechanism 2
- Claim: Group-conditional conformal prediction maintains valid coverage for each group by estimating group-specific quantiles.
- Mechanism: The calibration procedure is repeated per group, or group membership indicators are used in a quantile regression model to jointly estimate all group quantiles.
- Core assumption: Group membership is known at calibration time and is correctly specified in the regression model.
- Evidence anchors:
  - [abstract]: "To address this, they propose a group-conditional conformal prediction approach using quantile regression to estimate decision quantiles jointly for all groups."
  - [section]: "We propose a simple and more elegant reformulation of the group-conditional conformal calibration procedure via quantile regression... This constitutes the calibration of the conformal procedure."
- Break condition: If group membership indicators are misspecified or missing, the quantile regression cannot recover the correct group-conditional quantiles.

### Mechanism 3
- Claim: Quantile regression for calibration yields smaller average prediction set sizes while maintaining group coverage.
- Mechanism: By jointly modeling group-conditional quantiles, the regression borrows strength across groups, producing tighter but still valid prediction sets.
- Core assumption: The conditional quantile of the score given group membership can be well approximated by a linear model in the indicator variables.
- Evidence anchors:
  - [abstract]: "This method successfully maintains the required coverage level for all groups while producing smaller prediction sets compared to the iterative group-conditional approach."
  - [section]: "Quantile regression calibration has been shown empirically to maintain the 1 − α coverage level for all groups... This approach also provided smaller prediction sets, on average, per group."
- Break condition: If the linearity assumption is strongly violated, the quantile regression estimates will be biased, potentially violating coverage.

## Foundational Learning

- Concept: Exchangeability assumption in conformal prediction.
  - Why needed here: It is the minimal condition required for marginal coverage guarantees; the paper shows that it does not imply conditional coverage.
  - Quick check question: If the calibration data are not exchangeable, can marginal conformal prediction still provide valid coverage?

- Concept: Group-conditional coverage vs marginal coverage.
  - Why needed here: The paper contrasts marginal APS (which only guarantees average coverage) with group-conditional APS (which guarantees coverage per group).
  - Quick check question: If group A has 1000 samples and group B has 10, can marginal APS guarantee coverage for group B?

- Concept: Quantile regression as a calibration tool.
  - Why needed here: The proposed method replaces per-group iterative calibration with a joint quantile regression over group membership indicators.
  - Quick check question: In a regression model with indicator variables for two groups, how is the quantile for each group computed from the estimated coefficients?

## Architecture Onboarding

- Component map:
  Base classifier (ResNet18) -> Calibration set -> Conformity scores -> Quantile regression on group indicators -> Prediction set construction via thresholded cumulative softmax scores

- Critical path:
  1. Train base classifier on training set I1, extract softmax outputs for calibration set I2
  2. Fit quantile regression on group indicators and scores to estimate 1-α quantiles
  3. For new input: compute scores, plug group indicators into regression, obtain group-conditional quantile, build prediction set

- Design tradeoffs:
  - Iterative group-conditional: simpler to implement, but scales poorly with number of groups
  - Quantile regression: joint estimation, smaller sets, but requires correct model specification for group effects
  - Linear vs non-linear regression: trade-off between interpretability and flexibility

- Failure signatures:
  - Coverage drops for under-represented groups → suggests quantile regression model is misspecified
  - Very large prediction sets for all groups → suggests over-conservative quantile estimates
  - Inconsistent coverage across resamples → suggests instability in calibration

- First 3 experiments:
  1. Run marginal APS on the dataset and verify average coverage ≈ 90% but per-group coverage varies widely.
  2. Implement iterative group-conditional APS and compare per-group coverage and set sizes to marginal APS.
  3. Implement quantile regression calibration, verify joint quantile estimates, and compare both coverage and set sizes to iterative method.

## Open Questions the Paper Calls Out

### Open Question 1
- Question: How can conformal prediction methods be adapted for object detection and image segmentation tasks in agricultural applications?
- Basis in paper: [explicit] The authors mention future work aims at adapting and presenting the conformal methodology on other computer vision tasks such as object detection and image segmentation.
- Why unresolved: While the paper demonstrates conformal prediction for weed and crop classification, it does not explore its applicability to other common agricultural computer vision tasks that involve localizing or segmenting objects rather than classifying entire images.
- What evidence would resolve it: Empirical results showing conformal prediction methods successfully applied to object detection and segmentation tasks in agricultural datasets, with maintained coverage guarantees.

### Open Question 2
- Question: How does the performance of quantile regression calibration compare to the iterative group-conditional APS approach in terms of computational efficiency and scalability?
- Basis in paper: [explicit] The authors propose quantile regression calibration as an "elegant" and more efficient alternative to the iterative group-conditional APS approach, but do not provide a detailed computational comparison.
- Why unresolved: While the paper suggests quantile regression may be more efficient, it does not provide quantitative evidence or analysis of the computational benefits, particularly for scenarios with many groups or large datasets.
- What evidence would resolve it: A systematic comparison of computational time and resources required for both methods across various dataset sizes and numbers of groups.

### Open Question 3
- Question: What are the theoretical guarantees for maintaining group coverage when using quantile regression calibration?
- Basis in paper: [inferred] The authors note that "even though the variance of the observed coverage is naturally higher for less-represented groups, it is still acceptably maintained over the 100 iterations" but do not provide formal theoretical proofs.
- Why unresolved: The paper demonstrates empirical validity of the quantile regression approach but lacks theoretical justification for why group coverage is maintained, which is crucial for establishing the method's reliability.
- What evidence would resolve it: Mathematical proofs demonstrating that the quantile regression calibration method maintains the group-conditional coverage guarantee defined in Equation 2 under the assumptions made.

## Limitations
- The method requires meaningful auxiliary metadata for group definition; without it, group-conditional coverage cannot be enforced
- Performance depends on having sufficient calibration samples per group to reliably estimate group-specific quantiles
- The linear quantile regression assumption may fail for highly non-linear relationships between group membership and conformity score distributions

## Confidence
- **High confidence**: The theoretical framework of group-conditional conformal prediction and its distinction from marginal conformal prediction is well-established
- **Medium confidence**: The effectiveness of quantile regression for joint estimation of group-conditional quantiles is empirically demonstrated but may depend on dataset characteristics
- **Low confidence**: The generalizability of results to other agricultural settings or domains with different group structures remains to be verified

## Next Checks
1. **Group representation analysis**: Verify that the calibration set contains adequate representation from all groups, particularly rare groups, and assess how group size affects the accuracy of quantile regression estimates
2. **Model specification test**: Compare linear quantile regression against non-linear alternatives (e.g., random forest quantile regression) to evaluate whether the linear assumption is limiting performance
3. **Cross-domain validation**: Apply the method to a different agricultural dataset with different crops, environmental conditions, or imaging conditions to assess robustness across varying group structures
---
ver: rpa2
title: 'Colour Passing Revisited: Lifted Model Construction with Commutative Factors'
arxiv_id: '2309.11236'
source_url: https://arxiv.org/abs/2309.11236
tags:
- factors
- colour
- factor
- randvars
- each
- transformers
- self-attention
- retrieval-augmented-generation
- instruction-tuning
- parameter-efficient-finetuning
- mixture-of-experts
- chain-of-thought
core_contribution: "This paper introduces Advanced Colour Passing (ACP), a modified\
  \ version of the state-of-the-art Colour Passing (CP) algorithm for constructing\
  \ lifted representations of probabilistic models. ACP addresses two key limitations\
  \ of CP: (1) it handles commutative factors\u2014factors that map to identical values\
  \ regardless of argument order\u2014by using logical variables and counting random\
  \ variables to compactly encode symmetries within factors; and (2) it detects identical\
  \ factors independent of their argument order by employing histograms for efficient\
  \ comparison."
---

# Colour Passing Revisited: Lifted Model Construction with Commutative Factors

## Quick Facts
- arXiv ID: 2309.11236
- Source URL: https://arxiv.org/abs/2309.11236
- Reference count: 40
- Primary result: Advanced Colour Passing (ACP) achieves up to 30× speedup over Colour Passing for models with commutative factors

## Executive Summary
This paper introduces Advanced Colour Passing (ACP), an improved algorithm for constructing lifted representations of probabilistic models. ACP addresses key limitations in the state-of-the-art Colour Passing (CP) algorithm by handling commutative factors—factors whose potential values remain identical regardless of argument order. The method uses logical variables and counting random variables to compactly encode symmetries within factors, and employs histograms to efficiently detect identical factors independent of their argument order. Unlike CP, ACP produces a valid parametric factor graph (PFG) that is independent of any specific inference algorithm, enabling significantly faster inference times for large models.

## Method Summary
ACP extends the colour passing algorithm by introducing two key innovations: (1) counting random variables (CRVs) that compactly represent commutative factors by counting over a logvar, and (2) histogram-based comparison for detecting identical factors regardless of argument order. The algorithm performs an offline preprocessing step that identifies commutative factors within each factor and identical factors across the graph, then constructs a PFG with logical variables and parameterised randvars. This PFG maintains equivalent semantics to the original factor graph for the domain-liftable fragment while enabling lifted inference algorithms to operate on a compressed model. The approach is complete for models with at most two logvars per parfactor and one logvar per PRV.

## Key Results
- ACP produces valid PFGs independent of specific inference algorithms
- Up to 30× speedup compared to CP for models with commutative factors
- Up to 25× speedup for models with permuted factor arguments
- Significantly reduces inference times while maintaining model equivalence

## Why This Works (Mechanism)

### Mechanism 1
- Claim: Using counting random variables (CRVs) and histograms enables ACP to compactly encode commutative factors and detect identical factors regardless of argument order.
- Mechanism: ACP replaces factors with symmetric argument permutations by CRVs that count over a logvar, mapping each possible histogram to a unique potential. For identical factors with permuted arguments, histograms are compared as multisets of mapped values to detect equivalence independent of argument order.
- Core assumption: Factors are either commutative or have some symmetry that can be captured by counting over a subset of arguments, and the number of factor arguments remains small enough for histogram enumeration to be tractable.
- Evidence anchors:
  - [abstract] states ACP "uses logical variables and counting random variables to compactly encode symmetries within factors" and "detects identical factors independent of their argument order by employing histograms for efficient comparison."
  - [section 3.1] describes how CRVs compactly encode commutative factors by replacing a factor's argument list with a CRV counting over a logvar, reducing the table from exponential to polynomial in the number of arguments.
  - [section 3.2] explains that histograms allow order-independent detection of identical factors by comparing multisets of mapped values instead of checking all permutations.
- Break condition: If factors have a large number of arguments (exponential blowup in histogram size) or lack any symmetry, CRVs and histograms cannot effectively compress the representation and the method loses advantage.

### Mechanism 2
- Claim: ACP achieves significant inference speedup by producing a valid parametric factor graph (PFG) independent of any specific inference algorithm.
- Mechanism: ACP modifies the colour passing algorithm to construct a PFG with logical variables (logvars) and parameterised randvars (PRVs) that represent groups of indistinguishable randvars and factors, allowing lifted inference algorithms to operate on a compressed model without recomputing groupings per query.
- Core assumption: The domain-liftable fragment constraints (at most two logvars per parfactor and at most one logvar per PRV) are sufficient to capture practical model structure, and the lifted inference algorithms are complete for this fragment.
- Evidence anchors:
  - [abstract] states ACP "produces a valid lifted representation independent of any specific inference algorithm" and "drastically increases compression, yielding significantly faster online query times."
  - [section 4] describes how ACP constructs a PFG from groupings of randvars and factors, introducing logvars according to rules that ensure the resulting PFG has equivalent semantics to the original factor graph for the domain-liftable fragment.
  - [section 5] provides experimental evidence showing up to 30x speedup compared to CP and up to 25x speedup for models with permuted factor arguments.
- Break condition: If models fall outside the domain-liftable fragment (e.g., more than two logvars per parfactor or more than one logvar per PRV), the lifted inference algorithms lose completeness and the speedup advantage diminishes.

### Mechanism 3
- Claim: ACP efficiently detects more symmetries than CP by considering both internal factor symmetries and cross-factor symmetries in a single offline preprocessing step.
- Mechanism: ACP first checks for commutativity within each factor by testing subsets of arguments for symmetric potential mappings, then uses histograms to filter candidate factor pairs before checking permutations, avoiding the need to test all O(n!) permutations.
- Core assumption: Practical models contain exploitable symmetries, and the number of factor arguments remains small enough that commutativity checks and histogram comparisons are computationally feasible.
- Evidence anchors:
  - [abstract] claims ACP "efficiently detects more symmetries than the state of the art and thereby drastically increases compression."
  - [section 3.1] explains that checking O(2^n) subsets for commutativity within a factor is often reduced by only considering subsets of randvars with the same number of neighbours, and that practical applications assume some symmetries exist.
  - [section 3.2] describes using histograms to filter candidates before comparing permutations, avoiding the need to try all O(n!) permutations in advance.
- Break condition: If models lack symmetries or have factors with many arguments (making commutativity checks and histogram comparisons expensive), ACP cannot find additional compression beyond CP and the overhead may outweigh benefits.

## Foundational Learning

- Concept: Parametric factor graphs (PFGs) and lifted probabilistic inference
  - Why needed here: ACP constructs a PFG as a lifted representation of a propositional factor graph, and the speedup comes from lifted inference operating on this compressed model.
  - Quick check question: What is the key difference between a propositional factor graph and a parametric factor graph in terms of how randvars are represented?

- Concept: Colour passing algorithm and its limitations
  - Why needed here: ACP builds on the colour passing algorithm but modifies it to handle commutative factors and produce a valid PFG independent of inference algorithm; understanding CP's limitations motivates ACP's improvements.
  - Quick check question: Why does the original colour passing algorithm fail to group randvars A and B in a commutative factor φ(A,B) where φ(true,false) = φ(false,true)?

- Concept: Counting random variables (CRVs) and histograms for symmetry detection
  - Why needed here: ACP uses CRVs to compactly encode commutative factors and histograms to detect identical factors independent of argument order; these are the key technical innovations that enable compression.
  - Quick check question: How does a counting random variable #X[R(X)] with domain size 2 capture the three possible histograms for two Boolean randvars?

## Architecture Onboarding

- Component map: Factor Graph -> ACP Preprocessing -> Parametric Factor Graph -> Lifted Inference
- Critical path:
  1. Initialize randvar and factor colours based on ranges, evidence, and potentials
  2. Pass colours between randvars and factors, recording positions for non-commutative factors
  3. Group randvars and factors based on received signatures, introducing CRVs where commutativity detected
  4. Construct PFG from groups using rules for logvar introduction (Definition 6)
  5. Perform lifted inference on resulting PFG
- Design tradeoffs:
  - Compression vs. model expressiveness: Restricting to domain-liftable fragment enables completeness but may exclude some practical models
  - Preprocessing time vs. inference speedup: ACP requires offline computation to detect symmetries, but this pays off in faster online inference
  - CRV granularity vs. compression: Using CRVs for partial commutativity provides more compression but may complicate model structure
- Failure signatures:
  - No compression achieved: Input FG lacks symmetries, or factors have too many arguments for CRVs/histograms to be effective
  - Preprocessing takes too long: Models have many factors with large argument lists, making commutativity checks and histogram comparisons expensive
  - Lifted inference fails: Resulting PFG falls outside domain-liftable fragment, breaking completeness guarantees of LVE/LJT
- First 3 experiments:
  1. Run ACP on a small FG with one commutative factor and compare resulting PFG structure to original FG to verify CRV introduction and logvar assignment
  2. Create an FG with factors having permuted arguments, run ACP and CP, and compare the number of groups and compression achieved
  3. Vary the percentage of commutative factors in an FG and measure the tradeoff between preprocessing time and inference speedup to find the break-even point

## Open Questions the Paper Calls Out

- Open Question 1: How does ACP perform when applied to larger, more complex real-world probabilistic models beyond the synthetic datasets used in the experiments?
  - Basis in paper: [inferred] The paper demonstrates ACP's effectiveness on synthetic factor graphs with controlled properties, but does not test it on real-world models.
  - Why unresolved: The experiments focus on synthetic datasets to isolate specific factors (commutative factors, permuted arguments) and control for variables. Real-world models often have different structures and symmetries that may not be captured by the synthetic data.
  - What evidence would resolve it: Testing ACP on a variety of real-world probabilistic models from different domains (e.g., social networks, bioinformatics, natural language processing) and comparing its performance to CP and VE.

- Open Question 2: What is the impact of the order in which commutative factors are checked and converted to CRVs on the overall compression and inference time?
  - Basis in paper: [explicit] The paper mentions that ACP checks for commutativity within factors but does not specify the order in which factors are checked.
  - Why unresolved: The order of checking commutative factors could potentially affect the compression achieved by ACP and the resulting inference time. Different orders might lead to different groupings and CRV introductions.
  - What evidence would resolve it: Experiments comparing the performance of ACP with different orders of checking commutative factors (e.g., random order, largest factor first, smallest factor first) and analyzing the resulting compression and inference times.

- Open Question 3: How does ACP handle factors with more than two arguments that are partially commutative with respect to multiple subsets of their arguments?
  - Basis in paper: [explicit] The paper defines partially commutative factors but only provides examples with two arguments.
  - Why unresolved: The paper does not explore the behavior of ACP when dealing with factors with more than two arguments and multiple subsets of commutative arguments. The complexity of checking commutativity and introducing CRVs might increase significantly in such cases.
  - What evidence would resolve it: Analyzing the performance of ACP on factor graphs containing factors with more than two arguments and multiple subsets of commutative arguments, and investigating the impact on compression and inference time.

## Limitations

- Synthetic benchmarks limit generalizability to real-world models
- Domain-liftable fragment constraints may exclude some practical models
- No validation across multiple inference algorithms beyond LVE/LJT

## Confidence

- High confidence: The core mechanism of using counting random variables for commutative factors is technically sound and well-explained.
- Medium confidence: The experimental speedup claims are credible given the theoretical advantages, but the synthetic nature of benchmarks limits generalizability.
- Low confidence: The claim about producing algorithm-independent representations would benefit from testing with additional inference algorithms not mentioned in the paper.

## Next Checks

1. Test ACP on real-world factor graphs (e.g., from UAI or UIMPRAC benchmarks) to verify speedup claims hold for naturally occurring symmetries.
2. Implement ACP's CRV and histogram mechanisms separately and verify they correctly identify commutative factors and order-independent duplicates on edge cases.
3. Compare ACP's compression against alternative symmetry detection methods like those in "Efficient Detection of Commutative Factors in Factor Graphs" on identical datasets to quantify relative improvement.
---
ver: rpa2
title: Refining Diffusion Planner for Reliable Behavior Synthesis by Automatic Detection
  of Infeasible Plans
arxiv_id: '2310.19427'
source_url: https://arxiv.org/abs/2310.19427
tags:
- restoration
- plans
- diffusion
- learning
- planning
- transformers
- self-attention
- retrieval-augmented-generation
- instruction-tuning
- parameter-efficient-finetuning
- mixture-of-experts
- chain-of-thought
core_contribution: This paper proposes a method to refine unreliable plans generated
  by diffusion models in long-horizon planning tasks. The core idea is to detect infeasible
  plans using a metric called restoration gap, which measures the ability to restore
  a plan after adding noise.
---

# Refining Diffusion Planner for Reliable Behavior Synthesis by Automatic Detection of Infeasible Plans

## Quick Facts
- arXiv ID: 2310.19427
- Source URL: https://arxiv.org/abs/2310.19427
- Reference count: 40
- This paper proposes a method to refine unreliable plans generated by diffusion models in long-horizon planning tasks.

## Executive Summary
This paper addresses the challenge of unreliable plans generated by diffusion models in long-horizon planning tasks. The authors propose a method to detect and refine these unreliable plans using a novel metric called restoration gap. By estimating the restoration gap with a gap predictor and providing guidance to the diffusion planner, the method significantly improves planning performance. Additionally, an attribution map regularizer is introduced to prevent adversarial guidance from sub-optimal gap predictors.

## Method Summary
The method involves training a gap predictor to estimate the restoration gap of individual plans generated by a diffusion planner. This gap predictor is then used to provide guidance during the denoising process, aiming to minimize the restoration gap. An attribution map regularizer is added to prevent adversarial guidance from the sub-optimal gap predictor. The approach is validated on various tasks including Maze2D, locomotion, and block stacking.

## Key Results
- The proposed method significantly improves planning performance compared to baselines like Diffuser and model-free RL algorithms.
- The restoration gap metric effectively detects infeasible plans by measuring the ability to restore a plan after adding noise.
- The method provides explainability by highlighting error-prone transitions in plans.

## Why This Works (Mechanism)

### Mechanism 1
- **Claim:** The restoration gap metric can detect infeasible plans by measuring how well a noisy plan can be restored to its original state.
- **Mechanism:** Feasible plans have temporal compositionality, meaning they can be restored from noise corruption. Infeasible plans violate physical constraints and cannot be well restored.
- **Core assumption:** Temporal compositionality holds for feasible plans generated by diffusion models.
- **Evidence anchors:**
  - [abstract] "We suggest a new metric named restoration gap for evaluating the quality of individual plans generated by the diffusion model."
  - [section] "We hypothesize that for feasible plans, even if a certain amount of noise perturbs them, they can be closely restored to their initial plans by diffusion models."
  - [corpus] Weak - no direct citations about temporal compositionality in diffusion planners.
- **Break condition:** If temporal compositionality doesn't hold (e.g., in tasks with non-Markovian dynamics), restoration gap may not effectively distinguish feasible from infeasible plans.

### Mechanism 2
- **Claim:** Restoration Gap Guidance (RGG) improves plan quality by guiding the diffusion process to minimize the restoration gap.
- **Mechanism:** A gap predictor estimates the restoration gap and provides gradient guidance to reduce it during the denoising process.
- **Core assumption:** The gap predictor can accurately estimate restoration gaps for individual plans.
- **Evidence anchors:**
  - [abstract] "A restoration gap is estimated by a gap predictor which produces restoration gap guidance to refine a diffusion planner."
  - [section] "With this gap predictor, we define the Restoration Gap Guidance (RGG)..."
  - [corpus] Weak - no direct citations about gap predictor performance in diffusion planning.
- **Break condition:** If the gap predictor is inaccurate or biased, RGG may push plans in undesirable directions or fail to improve quality.

### Mechanism 3
- **Claim:** Attribution map regularization prevents adversarial guidance from sub-optimal gap predictors.
- **Mechanism:** Total variation of the attribution map is regularized to prevent the gap predictor from directing plans toward unreliable transitions.
- **Core assumption:** High attribution scores indicate unreliable transitions that contribute to high restoration gaps.
- **Evidence anchors:**
  - [abstract] "We additionally present an attribution map regularizer to prevent adversarial refining guidance that could be generated from the sub-optimal gap predictor..."
  - [section] "We measure a total variation of the attribution map M obtained from any input attribution methods..."
  - [corpus] Weak - no direct citations about attribution map regularization in diffusion planning.
- **Break condition:** If attribution maps don't accurately identify unreliable transitions, regularization may not prevent adversarial guidance.

## Foundational Learning

- **Concept: Diffusion probabilistic models**
  - Why needed here: The method builds on diffusion models for trajectory planning, so understanding how they work is essential.
  - Quick check question: How does the denoising process in diffusion models relate to score estimation?

- **Concept: Temporal compositionality in planning**
  - Why needed here: The restoration gap relies on the assumption that feasible plans can be restored from noise due to temporal compositionality.
  - Quick check question: What does temporal compositionality mean in the context of trajectory planning?

- **Concept: Input attribution methods**
  - Why needed here: The regularization component uses attribution maps to identify unreliable transitions.
  - Quick check question: How do attribution methods like Grad-CAM or DeepLIFT work for identifying important features?

## Architecture Onboarding

- **Component map:** Diffusion planner (Diffuser) -> Gap predictor -> Restoration Gap Guidance (RGG) -> Attribution map regularizer -> Refined plan

- **Critical path:**
  1. Generate plan with diffusion planner
  2. Compute restoration gap estimate with gap predictor
  3. Apply RGG to refine plan during denoising
  4. Regularize attribution maps to prevent adversarial guidance
  5. Output refined plan

- **Design tradeoffs:**
  - Gap predictor accuracy vs. computational cost: More accurate predictors require more data and training time
  - Perturbation magnitude (t) vs. error probability: Larger t values improve detection but may affect guidance quality
  - Regularization strength (λ) vs. plan quality: Too much regularization may oversmooth plans, too little may allow adversarial guidance

- **Failure signatures:**
  - Plans still contain infeasible transitions after refinement: Gap predictor may be inaccurate or RGG may not be strong enough
  - Performance degrades with increased regularization: Attribution map regularization may be too aggressive
  - High computational cost: Gap predictor training or RGG application may be too expensive

- **First 3 experiments:**
  1. Compare restoration gap values for plans with known feasible vs. infeasible transitions in a simple environment (e.g., Maze2D)
  2. Apply RGG to Diffuser-generated plans and measure performance improvement in a controlled task
  3. Test attribution map regularization by comparing plan quality with and without regularization in a task with known unreliable transitions

## Open Questions the Paper Calls Out

### Open Question 1
- Question: What is the optimal value of the restoration gap perturbation magnitude (t̂) for different task domains?
- Basis in paper: [inferred] The paper states that setting t̂ = 0.9 works well in practice, but notes that Proposition 1 suggests a larger t̂ is needed for low error probabilities. They conduct ablation studies with t̂ = 0.3, 0.5, 0.7, and 0.9.
- Why unresolved: The paper only tests a limited range of t̂ values (0.3 to 0.9) and does not systematically explore the relationship between t̂ and task complexity or domain-specific characteristics.
- What evidence would resolve it: A comprehensive study varying t̂ across different task domains (e.g., navigation, locomotion, manipulation) and measuring both restoration gap detection accuracy and planning performance would identify optimal t̂ values for each domain.

### Open Question 2
- Question: How does the attribution map regularizer's effectiveness scale with task complexity and planning horizon length?
- Basis in paper: [explicit] The paper mentions that λ > 0 consistently outperforms λ = 0 (no regularization) in Maze2D tasks, but only shows marginal improvement in locomotion tasks where they use a shorter planning horizon.
- Why unresolved: The paper does not provide a systematic analysis of how the regularizer's effectiveness varies with planning horizon length or task complexity. They only mention that locomotion tasks use a "shorter planning horizon" but don't specify what constitutes "shorter."
- What evidence would resolve it: A controlled experiment varying planning horizon length and task complexity while measuring the performance difference between RGG+ and RGG would quantify the regularizer's effectiveness scaling properties.

### Open Question 3
- Question: Can the restoration gap metric be effectively extended to continuous-time planning tasks or tasks with non-Euclidean state spaces?
- Basis in paper: [inferred] The paper develops the restoration gap metric within the framework of diffusion probabilistic models using VE-SDE, which assumes Euclidean state spaces. The theoretical analysis (Proposition 1) relies on L2 distances and χ2 distributions.
- Why unresolved: The paper only validates the restoration gap on discrete-time control tasks with Euclidean state spaces (navigation, locomotion, block stacking). There is no discussion of how the metric would generalize to continuous-time tasks or tasks with non-Euclidean state spaces (e.g., robot arms with joint angle constraints, or tasks on manifolds).
- What evidence would resolve it: Experimental validation of the restoration gap metric on continuous-time planning tasks and tasks with non-Euclidean state spaces, along with theoretical analysis extending Proposition 1 to these settings, would demonstrate the metric's broader applicability.

## Limitations
- The core assumption of temporal compositionality enabling restoration gap detection is plausible but not rigorously validated
- Gap predictor accuracy and its impact on RGG effectiveness is not thoroughly evaluated
- Attribution map regularization mechanism lacks clarity - it's unclear how the regularization prevents adversarial guidance

## Confidence
- High confidence: The restoration gap concept as a metric for plan quality is well-defined and experimentally validated
- Medium confidence: The overall approach of using gap prediction for guidance shows consistent performance improvements across tasks
- Low confidence: The attribution map regularization component - limited explanation of mechanism and minimal impact analysis

## Next Checks
1. Perform controlled experiments testing restoration gap sensitivity to perturbation magnitude t across different plan qualities to verify the temporal compositionality assumption
2. Conduct ablation studies comparing RGG performance with gap predictors of varying accuracy to establish the predictor's impact on plan quality
3. Evaluate attribution map regularization by measuring its effect on both plan quality and gap predictor reliability in scenarios with known adversarial guidance
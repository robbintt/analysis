---
title: 'MAPRO: Recasting Multi-Agent Prompt Optimization as Maximum a Posteriori Inference'
arxiv_id: '2510.07475'
source_url: https://arxiv.org/abs/2510.07475
generated_at: '2026-02-03T06:37:47'
quality_score: 9
citation_count: 40
model_profiles_used:
- default
- fast
model_profiles:
  default:
    provider: cerebras
    name: zai-glm-4.7
    temperature: 0.9
    top_p: 0.95
    max_tokens: 150000
  fast:
    provider: cerebras
    name: zai-glm-4.7
    temperature: 0.9
    top_p: 0.95
    max_tokens: 150000
---

# MAPRO: Recasting Multi-Agent Prompt Optimization as Maximum a Posteriori Inference

*Zheyuan Zhang; Lin Ge; Hongjiang Li; Weicheng Zhu; Chuxu Zhang; Yanfang Ye*

---

<div style="background-color: #f4f4f9; padding: 15px; border-radius: 8px; border-left: 5px solid #4a90e2; margin-bottom: 20px;">

### ðŸ“Š Quick Facts

*   **Quality Score:** 9/10
*   **Citations:** 40
*   **Core Innovation:** Formulates prompt optimization as Maximum a Posteriori (MAP) inference
*   **Computational Complexity:** Reduced from Exponential ($K^N$) to Polynomial
*   **Performance Gain:** +19.8% success rate over manual baselines (MADataset)
*   **Top Benchmark:** 81.3% success rate in collaborative writing tasks

</div>

## Executive Summary

Optimizing prompts for Large Language Model (LLM) multi-agent systems faces two critical bottlenecks that hinder reliable deployment: **combinatorial explosion** and **ambiguous credit assignment**. As the number of agents ($N$) grows, the search space for prompts scales exponentially ($K^N$), rendering manual engineering and standard automated tuning infeasible. Furthermore, determining whether a system failure stems from an individual agent's incompetence or from defective interactions between agents is notoriously difficult. This ambiguity prevents effective refinement, as developers cannot isolate the source of errors within complex agent networks.

This paper introduces **MAPRO** (Multi-Agent PRompt Optimization), a framework that recasts prompt optimization as a Maximum a Posteriori (MAP) inference problem to address these challenges. The methodology operates through a four-stage framework:

1.  **Initialization:** Generating diverse prompt pools via mutation and seeding a reward model.
2.  **Language-based MAP Selection (LMPBP):** Utilizing a language-guided variant of the max-product belief propagation algorithm to perform message passing and junction-tree transformations, identifying the global optimum in polynomial time.
3.  **Preference-based Prompt Policy Update:** Incorporating execution feedback and downstream blames to refine prompts.
4.  **Termination.**

By modeling the workflow as a directed graph where the joint quality score is a product of independent Bernoulli events, MAPRO enforces a "weakest link" principle that prioritizes critical bottlenecks and solves the credit assignment problem by distinguishing between node and edge failures.

**Performance Highlights:**
MAPRO demonstrates significant quantitative improvements over existing methods. On the MADataset benchmark, the framework achieves an average success rate improvement of **19.8%** compared to manually engineered baselines and outperforms the strongest automated alternative by **11.2%**. In specific collaborative tasks, MAPRO reached an **81.3%** success rate in collaborative writing (compared to 53.1% for manual methods) and **68.4%** in software development (compared to 38.6%).

The system successfully reduces computational complexity from exponential $K^N$ to polynomial time, effectively converging to coordinated, agent-specific prompt policies while avoiding the combinatorial trap that limits other approaches. This work establishes the first principled method for formulating multi-agent prompt optimization as a formal MAP inference task, bridging the gap between probabilistic graphical models and LLM agent tuning.

---

## Key Findings

*   **Superior Performance:** MAPRO consistently outperforms manually engineered baselines and recent automated alternatives across various benchmarks.
*   **Search Space Management:** The system effectively manages the exponentially expanding search space ($K^N$), avoiding combinatorial explosion through polynomial-time optimization.
*   **Credit Assignment Solution:** It effectively solves the ambiguous credit assignment problem by distinguishing between "Agent Incompetence" (node failure) and "Defective Interaction" (edge failure).
*   **Convergence:** The framework progressively converges to a coordinated set of agent-specific prompt policies.
*   **Theoretical Foundation:** Provides theoretical guidelines for building reliable multi-agent systems based on the "weakest link" principle.

---

## Methodology

The MAPRO framework utilizes a four-stage approach designed to optimize multi-agent workflows systematically:

1.  **Initialization**
    *   Generates diverse prompt pools via mutation.
    *   Seeds a reward model to guide early stages.

2.  **Language-based MAP Selection (LMPBP)**
    *   Implements a language-guided variant of the max-product belief propagation algorithm.
    *   Identifies the global optimum in polynomial time via message passing and junction-tree transformation.

3.  **Preference-based Prompt Policy Update**
    *   Utilizes a feedback loop integrating execution feedback.
    *   Uses downstream blames for selective, multi-level updates.

4.  **Termination**
    *   Concludes the process once optimization criteria are met.

---

## Technical Details

The system models the multi-agent workflow and optimization process using rigorous mathematical formulations:

### Graph Modeling
*   **Structure:** The workflow is represented as a directed graph $G=(V, E)$.
*   **Components:** Vertices ($V$) represent LLM agents, while edges ($E$) represent dependencies between agents.

### Optimization Formulation
*   **Objective:** Optimizes a joint quality score $T(\tilde{P})$.
*   **Probabilistic Model:** Formulated as a product of independent Bernoulli events for nodes and edges.
*   **Equivalence:** This formulation is mathematically equivalent to a Maximum a Posteriori (MAP) inference problem.

### Algorithmic Innovations
*   **Complexity Reduction:** Reduces search space complexity from $K^N$ (exponential) to polynomial time.
*   **Credit Assignment:** Solves the credit assignment problem by factorizing the joint probability, allowing the system to isolate failures to specific nodes or edges.
*   **Refinement Mechanism:** Includes a topology-aware refinement mechanism to manage instability and complexity.

---

## Contributions

*   **Principled Formulation:** Introduces the first principled method to formulate multi-agent prompt optimization as a MAP inference task.
*   **Algorithmic Innovation:** Develops an innovative algorithm combining language-guided max-product belief propagation with topology-aware refinement to manage instability and complexity.
*   **Empirical Validation:** The study empirically validates that automated optimization surpasses manual engineering.
*   **Theoretical Foundation:** Establishes a theoretical foundation for designing future multi-agent systems, bridging the gap between probabilistic graphical models and LLM agent tuning.